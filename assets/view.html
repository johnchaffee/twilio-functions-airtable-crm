<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" type="text/css" href="./css/stylesheet.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <title>Twilio Flex CRM Details</title>
  </head>
  <body>
    <div class="container">
      <div id="main-column" class="col-sm-12">
        <div class="row">
          <div class="col">
            <div class="pt-3">
              <div class="border p-3 bg-light">
                <h4>Contact Info</h4>
                <div id="contact-details" class="">
                  <!-- Contact Details go here -->
                </div>
              </div>
            </div>
            <div class="pt-3">
              <div class="border p-3 bg-light">
                <h4>Notes</h4>
                <div id="contact-notes" class="">
                  <!-- Notes go here -->
                </div>
                <hr />
                <form id="new-note" class="" action="#">
                  <div class="form-group">
                    <textarea
                      id="append-notes"
                      name="new-note"
                      rows="4"
                    ></textarea>
                    <br />
                    <a
                      id="confirm-notes"
                      class="submit btn btn-primary mt-1"
                      href="#"
                      >Add Notes</a
                    >
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="pt-3">
              <div class="border p-3 bg-light">
                <h4>New Appointment</h4>
                <div class="pt-3">
                  <form id="claim-form" class="" action="#">
                    <div class="form-group">
                      <input
                        id="date"
                        type="date"
                        name="date"
                        class="mb-2"
                      /><br />
                      <input
                        id="time"
                        type="time"
                        name="time"
                        value="09:00"
                      /><br />
                      <label for="serviceType" class="mt-2">Service type:</label
                      ><br />
                      <select id="serviceType">
                        <option value="tire-repair">Tire Repair</option>
                        <option value="replace-tires">Replace Tires</option>
                        <option value="replace-brakes">Replace Brakes</option>
                        <option value="oil-change">Oil Change</option></select
                      ><br />
                      <a
                        id="create-appointment"
                        class="submit btn btn-primary mt-3"
                        href="#"
                        >Create Appointment</a
                      >
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div
              id="success-alert"
              class="mt-3 alert alert-success alert-dismissible"
              style="display: none"
            >
              <button id="close-alert" type="button" class="close">
                &times;
              </button>
              <strong>Appointment Scheduled</strong>
            </div>
            <div
              id="failed-alert"
              class="mt-3 alert alert-danger alert-dismissible"
              style="display: none"
            >
              <button id="close-alert" type="button" class="close">
                &times;
              </button>
              <strong>Appointment NOT scheduled</strong>
            </div>
            <div class="pt-3">
              <div class="border p-3 bg-light">
                <h4>Appointment History</h4>
                <div class="pt-3">
                  <div id="appointment-history" class=""></div>
                </div>
              </div>
            </div>
            <div class="pt-3">
              <div class="border p-3 bg-light">
                <h4>Communication Log</h4>
                <div class="pt-3">
                  <div id="communication-log" class="">
                    <p>Calls go here</p>
                    <p>Chats go here</p>
                    <p>Messages go here</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <script src="./js/sampleContacts.js"></script> -->
    <script src="./js/phoneFormat.js"></script>
    <!-- Axios library -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      $(document).ready(function () {
        console.log("details.html > script > DOCUMENT.READY")
        const params = window.location.search
        console.log("PARAMS: " + params)
        const id = getParam("id")
        console.log("getParams ID: " + id)
        const field = getParam("field")
        console.log("getParams field: " + field)
        const value = getParam("value")
        console.log("getParams value: " + value)

        function getParam(paramName) {
          let query = window.location.search.substring(1)
          let params = query.split("&")
          for (let i = 0; i < params.length; i++) {
            let pair = params[i].split("=")
            if (decodeURIComponent(pair[0]) == paramName) {
              return decodeURIComponent(pair[1])
            }
          }
          console.log("Query param %s not found", paramName)
        }

        // Load first sample contact from ../js/sample-contacts.js
        // let contact = contacts[0]

        // GET RECORD BY ID
        const getRecordByField = async (field, value) => {
          console.log("GET RECORD BY ID")
          const options = {
            // url: `https://api.airtable.com/v0/${airtableBaseId}/${table}/${id}`,
            url: `./view?table=contacts&field=${field}&value=${encodeURIComponent(
              value
            )}`,
            method: "GET",
          }
          console.log("options:", options)
          try {
            const { data } = await axios(options)
            const record = data
            contact = record
            console.log("CONTACT:", contact)
            console.log("CONTACT.LENGTH:", contact.length)
          } catch (err) {
            console.log(
              "ERROR FETCHING CONTACT FROM AIRTABLE, USING SAMPLE CONTACT"
            )
            console.error(err)
          }
        }

        getRecordByField(field, value)
          .then(function () {
            console.log("GET RECORD BY ID THEN BUILD VIEW")
            if (contact.length != 0) {
              buildView(contact)
            } else {
              console.log("DISPLAY MODAL")
              // Display modal
            }
          })
          .catch(function (err) {
            console.log(err)
          })

        $("#myInput").on("keyup", function () {
          let value = $(this).val().toLowerCase()

          $("#contacts-table-body tr").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          })
        })
      })

      function buildView(contact) {
        console.log("BUILD VIEW")
        console.log(contact)
        let fullName = contact.fields.name
        $("#contact-details").ready(function () {
          let contactDetails = ""
          let contactImage = contact.fields.image ? contact.fields.image[0].url : "./images/contact.jpeg"
          contactDetails +=
            '<p><img width="150px" src="' +
            contactImage +
            '" alt="Picture"></p>' +
            "<b>" +
            fullName +
            "</b>" +
            "<p>Ph: " +
            formatNumber(contact.fields.phone) +
            "<br>Email: " +
            contact.fields.email +
            "</p>" +
            "<p>" +
            "123 Main Street" +
            "<br>" +
            "Seattle" +
            ", " +
            "WA" +
            " " +
            "98104" +
            "</p>"
          $("#contact-details").html(contactDetails)

          let contactNotes = ""
          if (contact.fields.notes != undefined) {
            const notesArray = contact.fields.notes.split("\n")
            notesArray.forEach((note) => {
              contactNotes += `<p>${note}<p>`
            })
            $("#contact-notes").html(contactNotes)
          }

          let appointmentHistory = ""
          if (contact.fields.appointments != undefined) {
            const appointmentsArray = contact.fields.appointments.split("\n")
            appointmentsArray.forEach((appointment) => {
              appointmentHistory += `<p>${appointment}<p>`
            })
          }
          $("#appointment-history").html(appointmentHistory)
        })
      }

      // Set today's date on Date picker
      let rightNow = new Date()
      // console.log("RIGHTNOW: " + rightNow)
      let year = rightNow.getFullYear()
      // console.log("year: " + year)
      let month = rightNow.getMonth() + 1
      month = ("0" + month).slice(-2)
      // console.log("month: " + month)
      let day = rightNow.getDate()
      day = ("0" + day).slice(-2)
      // console.log("day: " + day)
      let myDate = year + "-" + month + "-" + day
      console.log("myDate: " + myDate)
      $("#date").attr("value", myDate)

      $("#create-appointment").click(function (event) {
        event.preventDefault()
        $("#create-appointment").attr("disabled", true)
        $(".alert").hide()
        console.log("#create-appointment clicked")
        $("#success-alert").fadeIn("slow")
        $("#create-appointment").attr("disabled", false)
      })

      // CLOSE ALERT
      $("#close-alert").click(function () {
        $(".alert").fadeOut("fast")
      })
    </script>
  </body>
</html>
